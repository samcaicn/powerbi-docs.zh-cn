---
title: Power BI Premium 容量内存使用和优化
description: 了解 Power BI Premium 容量内存管理和优化。
ms.date: 04/30/2018
ms.topic: conceptual
ms.service: powerbi
ms.component: powerbi-admin
ms.author: mblythe
ms.reviewer: mblythe
author: mgblythe
manager: kfile
ms.openlocfilehash: aee7fb94f1e132783fc2b7791f7e634c903f7aa6
ms.sourcegitcommit: 1574ecba7530e6e0ee97235251a3138fb0e4789b
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/14/2018
ms.locfileid: "40257206"
---
# <a name="power-bi-premium-capacity-resource-management-and-optimization"></a>Power BI Premium 容量资源管理和优化

本文介绍 Power BI Premium 服务如何管理资源，并提供有关计划和优化解决方案的提示。

## <a name="premium-capacity-memory-management"></a>高级容量内存管理

 高级容量内存的使用者为：

* 加载数据集使用的内存
* 数据集刷新（计划和按需）使用的内存
* 报表查询使用的内存

当针对容量中已发布的数据集发出请求时，该数据集会从持久存储加载到内存中（这也称为映像加载）。 保持数据集加载在内存中有助于对此数据集的将来查询做出快速响应。 除了保持数据集加载在内存中而所需的内存，报表查询和数据集刷新还使用额外的内存。

### <a name="dataset-memory-estimation"></a>数据集内存估计

当尝试将数据集加载到内存时，Power BI 估计数据集完成请求的命令所需的内存量。 内存中的数据集大小往往比保存到磁盘时更大。 在数据集刷新期间，内存容量至少需要空闲状态下的内存量的两倍。

### <a name="overcommitting-capacity-eviction-and-reloading-of-datasets"></a>数据集的过度使用容量、逐出和重新加载

Power BI Premium 提供过度使用容量的便利。 例如，你可以发布比内存保存容量多的数据集。 如果容量中已发布的数据集需要的内存比适合容量多，则其中一些数据集将单独存储在持久存储中。 持久存储是与每个容量关联的 100 TB 存储的一部分。

因此，哪些数据集会保留在内存中，其他数据集会发生什么情况？ 如上所述，当针对数据集发出请求时，数据集将加载到内存中（映像加载）。 请求可能是报表查询或刷新操作。

由于可以过度使用容量，容量也可能面临内存压力。 当容量面临内存压力（由于需要加载新的数据集或某些加载数据集上的查询增加了内存要求），节点会逐出一个或多个占用容量内存的数据集。 首先逐出处于非活动状态的数据集（即没有当前正在执行的查询/刷新操作），逐出顺序采用“最近最少使用的 (LRU)”方式。 如果新命令发出到逐出数据集，则服务尝试将该数据集重新加载到内存中，这可能逐出其他数据集。 此行为允许容量服务于比内存保存量多的数据集，从而实现更高效的利用率。

将数据集加载到内存是成本相当高的操作。 根据数据集大小，它可能会持续几秒钟（对于小型数据集）到几十秒甚至数分钟（对于大约 10 GB 的大数据集）。 高级容量通过将最近最少使用的数据集尽可能长时间地保留在内存中，尝试最大程度地减少需要加载容量的次数。 当需要额外内存时，需要逐出某些数据集，并且系统将尝试选择对用户体验的影响最小的数据集。 当需要额外内存时，需要逐出某些数据集，并且系统将尝试选择对用户体验的影响最小的数据集。 例如，系统将避免逐出最后几分钟内有效使用的数据集，因为它们可能很快再次被查询。

逐出流程本身是快速操作。 如果逐出时数据集未在有效使用中，则用户不能确定逐出产生很大影响。 但是，如果同时有效使用太多数据集，并且没有足够的内存来保存所有这些数据集，会发生大量逐出。 这可能导致“抖动”情况，其中数据集不断逐出和重新加载，用户会发现响应时间和性能大幅下降。

### <a name="dataset-refresh-memory-requirement-competing-with-an-active-dataset-memory-requirement"></a>与活动数据集内存要求比争的数据集刷新内存要求

用户可以按计划或按需刷新数据集。 如上所述，完整刷新所需的内存至少是加载的数据集和空闲数据集的内存大小的两倍。 刷新开始前，估计刷新内存要求。 如果总内存要求多于容量中的可用内存，将逐出某些数据集。 按最近最少使用的数据集顺序选择逐出候选者，即服务尝试在内存中尽可能多地保存最近使用的数据集。

如果尽管逐出但所需的内存仍不可用，刷新将会排队进行重试。 服务进行重试，直到成功或新的刷新操作开始为止。

如果向容量中的任意数据集发出交互式查询，但由于正在刷新而没有足够可用内存，则该请求将失败，需要用户重试。

## <a name="cpu-resource-management-in-premium-capacity"></a>高级容量中的 CPU 资源管理

CPU 资源有两个主要使用者：

- 来自报表的查询
- 刷新（处理）

### <a name="queries-from-reports"></a>来自报表的查询

报表查询使用容量的 CPU 资源。 如果报表有一些效率低下的查询，或者你有许多并发用户，则会使用大量 CPU 资源且你的现有容量可能不足以处理负载。

### <a name="refresh-parallelization-policy"></a>刷新并行化策略

内存不是唯一可限制数据集刷新的资源。 服务器上的 v 核心数也可能是一个因素。 由于每个刷新操作需要一定数量的 v 核心，因此对并行运行的刷新数进行了限制。 下表中详细介绍了每个 SKU 的限制。 超出这些限制的其他刷新将进行排队。

 | SKU  | 后端虚拟核心  | 模型刷新并行   |
 | --- | --- | --- |
 | A1  | 0.5  | 1  |
 | A2  | 1  | 2  |
 | A3  | 2  | 3  |
 | A4  | 4  | 6  |
 | A5  | 8  | 12  |
 | A6  | 16  | 24  |
 | EM1  | 0.5  | 1  |
 | EM2  | 1  | 2  |
 | EM3  | 2  | 3  |
 | P1  | 4  | 6  |
 | P2  | 8  | 12  |
 | P3  | 16  | 24  |
 | P4  | 32  | 48  |
 | P5  | 64  | 96  |

 > [!TIP]
> 如果刷新延迟，请检查你的容量支持的并行刷新数。

## <a name="example-scenarios"></a>示例方案

下面介绍一些常见方案和服务执行的操作：

 **同时全部提交二十个计划的刷新** – Power BI 尝试同时启动前 x 个刷新。 x 的值由该 SKU 的刷新并行化策略确定。 如果 Power BI 无法通过逐出非活动数据集（最近不使用的数据集）而获得足够的内存，则并非所有 x 个刷新都同时启动。 任何无法启动的刷新将进行排队，直到可以启动为止。

 **同时运行两个刷新，而只有足够一个刷新完成的内存** – 启动可以完成的刷新。 稍后重试另一个刷新。

 **刷新一些数据集时正在查询大量数据集** – 如果没有足够可用的内存，Power BI 尝试停止活动刷新以便为交互式查询提供优先权。 这将降低刷新性能。

 **在当前容量大小上，数据集需要刷新太多内存** – 刷新将失败。 不会尝试通过逐出获得更多内存。

 **刷新具有较大内存峰值的单个数据集** – 如果峰值大于通过逐出非活动数据集而获得的内存量，稍后将重试刷新，直到有足够的内存来处理峰值。

 **对无法通过逐出所有非活动数据集和刷新而获取足够内存的数据集执行查询** - 这些查询将失败。 对于这些类型的工作负荷要求，应购买更高的容量。

## <a name="troubleshooting-and-testing"></a>故障排除和测试

如果报表速度慢或没有响应，则从仅测试报表上的一位用户开始操作。 然后，开始增加并发用户负载以查找限制。 在许多情况下，优化 DAX（报表查询）可以显著更改报表性能（以及增加你的容量所支持的并发用户数）。

在 Azure 中使用 Power BI Embedded 容量测试不同的 SKU，确定最适合预期的工作负荷的高级 SKU。 Power BI Embedded A4 SKU 等同于 P1、A5 = P2 和 A6 = P3。 在 Azure 中，可以通过在 Azure 门户中向上和向下扩展，在 SKU 之间轻松切换。 找到最适合工作负荷的 SKU 且完成测试后，可以删除 SKU。

在某些情况下，在计算机上打开模型的 PBIX 文件并检查内存和 CPU 消耗可以发现问题的大量信息。 这对于非常大的模型不会有帮助，但对于某些较小的模型，可以尝试在计算机中打开、刷新和查询模型。 当打开模型时检查模型大小、消耗的内存和 CPU。 尝试刷新和查询。 使用任务管理器来检查本地 PBIX 文件的 CPU 和内存消耗。 有时，计算机本身上的这些度量值表明较低的高级容量（如 P1/P2）可能不适用于你的解决方案。
